"""
工作流提示词模板
app/prompts/workflow_prompts.py
"""


class WorkflowPrompts:
    """工作流提示词管理类"""

    @staticmethod
    def extract_features(context: str, user_query: str) -> str:
        """提取患者特征的提示词"""
        return f"""{context}

### 当前用户问题
{user_query}

### 任务
请从以上信息中提取患者的关键特征，包括：

1. **主要疾病/诊断**: 明确患者的主要疾病名称
2. **病理类型和分期**: 如果提到，请列出详细的病理类型和TNM分期
3. **基因突变信息**: 列出所有提到的基因突变（如EGFR、ALK、ROS1等）
4. **既往治疗史**: 之前接受过的治疗方案
5. **当前状态和需求**: 患者目前的状态和想了解的内容

### 🎯 关键：生成入选/排除标准清单

基于以上特征，请生成一份结构化的**文献筛选标准**，格式如下：

**入选标准**（符合以下所有条件）：
- [ ] 成人患者（≥18岁）
- [ ] 晚期/转移性 [疾病名称]
- [ ] [基因突变类型]突变阳性
- [ ] [治疗线数]线治疗
- [ ] 其他关键条件...

**排除标准**（不符合以下任一条件）：
- [ ] 合并其他恶性肿瘤
- [ ] 严重肝肾功能不全
- [ ] 其他排除条件...

---

### ⚠️ 重要：输出格式约定

**如果无法提取到有效的患者特征，请直接输出**：

EXTRACT_FAILED: 无法从提供的信息中提取出有效的患者特征，请提供更详细的疾病信息、基因检测结果或治疗历史。

**如果成功提取，请以结构化的方式列出这些信息**。如果某些信息未提及，请标注“未提及”。"""

    @staticmethod
    def generate_queries(patient_features: str) -> str:
        """生成检索条件的提示词"""
        return f"""基于以下患者特征，生成精确且适度的检索条件：

### 患者特征
{patient_features}

### 任务
请生成以下检索条件：

1. **PubMed 检索表达式**: 使用布尔运算符（AND、OR）和 MeSH 主题词[Mesh]，例如：
   - `"Small Cell Lung Cancer"[Mesh] AND "Durvalumab"[All Fields]`
   - 注意：**只保留核心检索条件**，不要过度限制（如只针对疾病名称 + 1-2个关键词）

2. **Europe PMC 检索关键词**: 提取3-5个核心关键词，用逗号分隔，例如：
   - `small cell lung cancer, extensive stage, PIK3CA`
   - 注意：Europe PMC 不支持复杂的布尔表达式，只使用简单关键词

3. **ClinicalTrials.gov 关键词**: 提取3-5个核心关键词，用逗号分隔

---

### ⚠️ 重要：输出格式约定

**如果无法生成有效的检索条件（比如患者特征为空或不包含医疗信息），请直接输出**：

GENERATE_FAILED: 无法根据提供的信息生成检索条件，请提供更具体的疾病、基因或治疗信息。

**如果成功生成，必须严格遵守JSON格式**：

{{
    "pubmed_query": "这里是PubMed检索表达式，使用MeSH和布尔运算符",
    "europepmc_query": "这里是Europe PMC关键词，用逗号分隔",
    "clinical_trial_keywords": "关键词1,关键词2,关键词3"
}}

只输出 JSON 或 GENERATE_FAILED 标记，不要有其他内容。"""

    @staticmethod
    def analyze_paper(patient_features: str, user_query: str, paper: dict) -> str:
        """分析单篇文献的提示词（增强版）"""
        return f"""请仔细阅读这篇PDF文献，并基于以下信息进行深入分析：

### 患者特征与筛选标准
{patient_features}

### 用户问题
{user_query}

### 文献基本信息
- **标题**: {paper['title']}
- **作者**: {paper.get('authors', 'N/A')}
- **发表日期**: {paper.get('pub_date', 'N/A')}

---

### 📋 分析任务

#### 1️⃣ 入选/排除标准匹配度
请根据上述"患者特征与筛选标准"，逐条评估该文献的研究人群是否匹配：

| 标准 | 匹配度 | 说明 |
|------|--------|------|
| 成人患者 | 🟢/⚪/🔴 | 文献中的人群年龄范围 |
| 疾病类型 | 🟢/⚪/🔴 | 是否为同一疾病 |
| 基因突变 | 🟢/⚪/🔴 | 突变类型是否一致 |
| 治疗线数 | 🟢/⚪/🔴 | 治疗阶段是否匹配 |

**符合度评分**: X/10 分

#### 2️⃣ 研究设计与证据级别
请提取以下信息：

| 项目 | 内容 |
|------|------|
| 研究类型 | 随机对照试验(RCT) / 队列研究 / 病例系列... |
| 样本量 | N = ? |
| 研究地区 | 国家/地区 |
| 入组标准 | 关键入组条件 |
| 排除标准 | 关键排除条件 |
| 证据等级 | 1A / 1B / 2A... |

#### 3️⃣ 关键结果数据抽取
请提取数字和比例，标准化成表格：

| 疗效指标 | 数值 | 95% CI | P值 | 说明 |
|---------|------|--------|-----|------|
| 客观缓解率 (ORR) | X% | (X%-X%) | <0.05 | 肿瘤明显缩小的患者比例 |
| 无进展生存期 (PFS) | X 个月 | (X-X) | <0.001 | 中位无进展生存期 |
| 总生存期 (OS) | X 个月 | (X-X) | - | 中位总生存期 |
| 疾病控制率 (DCR) | X% | (X%-X%) | - | ORR + 疾病稳定率 |

**不良反应发生率**：

| 不良事件 | 3-4级发生率 | 说明 |
|---------|-------------|------|
| 皮疹 | X% | 常见不良反应 |
| 腹泻 | X% | - |
| 肝功能异常 | X% | - |

#### 4️⃣ 结论与临床意义
- **研究设计**: [简洁描述]
- **关键数据**: [核心数字]
- **结论**: [主要结论]
- **对患者的意义**: [实际指导意义]

#### 5️⃣ 来源可追溯性
请标注关键数据的来源页码，例如：
- ORR 数据：见原文第5页 Table 2
- PFS 数据：见原文第7页 Figure 3

---

**重要输出要求**：
- 使用Markdown格式输出
- 使用表格呈现数据
- 使用 🟢 表示符合，⚪ 表示不确定，🔴 表示不符合
- 使用**加粗**突出重要信息"""

    @staticmethod
    def analyze_trials(patient_features: str, trials_text: str) -> str:
        """分析临床试验的提示词"""
        return f"""基于患者特征评估以下临床试验的适配性：

### 患者特征与筛选标准
{patient_features}

### 临床试验列表
{trials_text}

---

### 分析任务
请针对每个试验进行评估：

#### 1️⃣ 入选/排除标准匹配度
请逐条评估：

| 标准 | 试验1 | 试验2 | 试验3 |
|------|-------|-------|-------|
| 年龄要求 | 🟢/⚪/🔴 | 🟢/⚪/🔴 | 🟢/⚪/🔴 |
| 疾病类型 | 🟢/⚪/🔴 | 🟢/⚪/🔴 | 🟢/⚪/🔴 |
| 基因突变 | 🟢/⚪/🔴 | 🟢/⚪/🔴 | 🟢/⚪/🔴 |
| 治疗线数 | 🟢/⚪/🔴 | 🟢/⚪/🔴 | 🟢/⚪/🔴 |

#### 2️⃣ 详细评估
针对每个试验：

**试验 X**
- **适配度评分**: X/100分
- **入组标准分析**: 患者是否符合
- **排除标准考量**: 是否存在排除因素
- **试验优势**: 该试验的优势和特点
- **潜在风险**: 可能的风险
- **推荐等级**: 强烈推荐/推荐/谨慎推荐/不推荐

最后给出**综合建议**，说明最适合的1-2个试验。"""

    @staticmethod
    def generate_final_report(
            user_query: str,
            patient_features: str,
            papers_summary: str,
            trial_analysis: str
    ) -> str:
        """生成最终报告的提示词"""
        return f"""请基于所有分析生成一份结构化的最终报告：

### 原始问题
{user_query}

### 患者特征摘要
{patient_features[:500]}...

### 文献分析汇总
{papers_summary}

### 临床试验分析摘要
{trial_analysis[:500] if trial_analysis else "暂无"}...

---

### 报告要求
请生成一份专业的医疗咨询报告，包含：

#### 1. 执行摘要
简要总结本次分析的核心内容

#### 2. 证据等级汇总表
将所有文献按证据等级排序：

| 文献编号 | 证据等级 | 研究类型 | 样本量 | 关键结论 |
|---------|---------|---------|--------|---------|
| 文献1 | 1A | RCT | N=500 | XXX |
| 文献2 | 2B | 队列 | N=200 | XXX |

#### 3. 治疗方案建议
基于文献分析，提供治疗方案建议（带数据支撑）

#### 4. 临床试验推荐
推荐最适合的1-2个临床试验，说明理由

#### 5. 关键数据对比
将相似研究的数据并列对比：

| 研究 | ORR | PFS | OS | 主要不良反应 |
|------|-----|-----|----|-----------| 
| 研究A | 70% | 12月 | 24月 | 皮疹(10%) |
| 研究B | 65% | 10月 | 22月 | 腹泻(8%) |

#### 6. 注意事项
提示需要注意的风险和问题

#### 7. 后续行动建议
给出具体的下一步建议

请保持专业、客观，使用易懂的语言。"""