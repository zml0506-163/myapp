import{r as y,a as z,n as _e,p as ye,q as Q,c as m,o as p,g as u,b as n,s as x,v as X,F as K,t as H,w as l,h as o,E as Z,x as A,d as b,y as he,z as we,A as O,j as D,B as w,k as h,C as ee,D as te,G as c,H as be}from"./index-DHBJJX_3.js";const Te={class:"container"},Pe={class:"search-container"},Ce=["disabled"],Ee={key:0},Ne={key:1},Ie={class:"output"},ke=["innerHTML"],Se=["href","data-ids","data-event-type"],Le=["src"],Ve={key:3,class:"msg-other"},Re={class:"search-container",style:{"margin-bottom":"15px"}},Ae={class:"title-cell"},Oe={key:0,class:"official-title"},De={class:"pagination-container",style:{"margin-top":"15px","text-align":"right"}},Ue={class:"search-container",style:{"margin-bottom":"15px"}},ze={class:"pagination-container",style:{"margin-top":"15px","text-align":"right"}},Be={__name:"SearchPubMed",setup(xe){const U=y(""),M=y(5),E=y(!1),W=y([]),B=y(!1),g=z({currentPage:1,pageSize:10,total:0}),k=y(!1),j=y([]),$=y(!1),f=z({currentPage:1,pageSize:10,total:0}),N=y([]),S=y(!1),ae=_e(()=>{const t=[];let e=[];try{console.debug("[renderedLines] rawMessages snapshot:",JSON.parse(JSON.stringify(N.value)))}catch{console.debug("[renderedLines] rawMessages (no clone):",N.value)}return N.value.forEach((r,i)=>{const v={...r};v.type==="text"&&(v.content==null&&(v.content=""),v.content=ye.sanitize(String(v.content))),v.newline?(e.length>0&&t.push(e),e=[v]):e.push(v)}),e.length>0&&t.push(e),console.debug("[renderedLines] final lines:",t.map(r=>r.map(i=>i.content))),t});async function ne(){if(U.value==""){A.warning("请输入搜索关键词！");return}N.value=[],S.value=!0;try{const t=await fetch("/api/search",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer YOUR_TOKEN"},body:JSON.stringify({q:U.value,limit:M.value})});if(!t.ok)throw new Error(`请求失败: ${t.status}`);const e=t.body.getReader(),r=new TextDecoder;for(;;){const{value:i,done:v}=await e.read();if(v)break;r.decode(i,{stream:!0}).split(`
`).forEach(I=>{if(I.trim())try{const C=JSON.parse(I);console.log(C),C.type==="done"?S.value=!1:N.value.push(C)}catch(C){console.error("解析SSE消息失败:",C,"原始行:",I)}})}}catch(t){console.error("搜索过程出错:",t),N.value.push({type:"text",content:`搜索失败：${t.message}`,newline:!0}),S.value=!1}}const d=z({pmid:"",title:"",author:""}),s=z({nctId:"",condition:"",status:""}),G=[{value:"ACTIVE_NOT_RECRUITING",label:"活跃但不招募",description:"研究正在进行，但不再招募参与者"},{value:"COMPLETED",label:"已完成",description:"研究已完成所有计划的试验活动"},{value:"ENROLLING_BY_INVITATION",label:"邀请招募",description:"仅通过邀请招募参与者"},{value:"NOT_YET_RECRUITING",label:"尚未招募",description:"研究已批准，但尚未开始招募参与者"},{value:"RECRUITING",label:"正在招募",description:"研究正在积极招募参与者"},{value:"SUSPENDED",label:"已暂停",description:"研究暂时停止，但可能会恢复"},{value:"TERMINATED",label:"已终止",description:"研究提前结束，不会恢复"},{value:"WITHDRAWN",label:"已撤回",description:"研究在开始前被撤回"},{value:"AVAILABLE",label:"可获取",description:"研究相关资源或数据可获取"},{value:"NO_LONGER_AVAILABLE",label:"不再可获取",description:"研究相关资源或数据不再可获取"},{value:"TEMPORARILY_NOT_AVAILABLE",label:"暂时不可获取",description:"研究相关资源或数据暂时不可获取"},{value:"APPROVED_FOR_MARKETING",label:"批准上市",description:"研究药物或疗法已批准上市"},{value:"WITHHELD",label:"已扣留",description:"研究信息被扣留"},{value:"UNKNOWN",label:"未知",description:"研究状态未知"}];function le(t){const e=G.find(r=>r.value===t);return e?e.label:t}function oe(t){return{RECRUITING:"success",ENROLLING_BY_INVITATION:"success",COMPLETED:"primary",ACTIVE_NOT_RECRUITING:"info",NOT_YET_RECRUITING:"info",APPROVED_FOR_MARKETING:"primary",SUSPENDED:"warning",TEMPORARILY_NOT_AVAILABLE:"warning",TERMINATED:"danger",WITHDRAWN:"danger",NO_LONGER_AVAILABLE:"danger",WITHHELD:"danger",AVAILABLE:"default",UNKNOWN:"default"}[t]||"default"}function re(t){const e=G.find(r=>r.value===t);return e?e.description:`未找到状态「${t}」的描述信息`}async function L(){B.value=!0;try{const t=new URL("/api/clinical_trials",window.location.origin);t.searchParams.append("page",g.currentPage),t.searchParams.append("page_size",g.pageSize),s.nctId&&t.searchParams.append("nct_id",s.nctId),s.condition&&t.searchParams.append("condition",s.condition),s.status&&t.searchParams.append("status",s.status);const e=await fetch(t.toString());if(!e.ok)throw new Error("获取数据失败");const r=await e.json();W.value=r.items,g.total=r.total}catch(t){console.error("获取临床试验数据失败:",t),A.error("获取临床试验数据失败，请重试")}finally{B.value=!1}}async function V(){$.value=!0;try{const t=new URL("/api/papers",window.location.origin);t.searchParams.append("page",f.currentPage),t.searchParams.append("page_size",f.pageSize),d.pmid&&t.searchParams.append("pmid",d.pmid),d.title&&t.searchParams.append("title",d.title),d.author&&t.searchParams.append("author",d.author);const r=await(await fetch(t.toString())).json();j.value=r.items,f.total=r.total}catch(t){console.error("获取文献数据失败:",t)}finally{$.value=!1}}function ie(t){g.pageSize=t,g.currentPage=1,L()}function se(t){g.currentPage=t,L()}function ue(t){f.pageSize=t,f.currentPage=1,V()}function de(t){f.currentPage=t,V()}function pe(t){let r=`/api/download/${encodeURIComponent(t)}`;const i=document.createElement("a");i.href=r,i.target="_blank",i.download="",i.click()}function Y(t){if(!t){A.warning("原始链接不存在");return}try{new URL(t);const e=window.open(t,"_blank");e?e.focus():A.warning("链接打开失败，请检查浏览器弹窗设置")}catch(e){console.error("打开原始链接失败:",e),A.error("链接格式无效，无法打开")}}function T(){g.currentPage=1,L()}function ce(){s.nctId="",s.condition="",s.status="",g.currentPage=1,L()}function P(){f.currentPage=1,V()}function ge(){d.pmid="",d.title="",d.author="",f.currentPage=1,V()}Q(E,t=>{t&&L()}),Q(k,t=>{t&&V()});const fe=t=>{const e=t.currentTarget.dataset.eventType;if(!e){console.warn("缺少 event_type ");return}switch(e){case"trial":const r=t.currentTarget.dataset.ids;s.nctId=r,E.value=!0,T();break;default:console.warn(`未处理的事件类型: ${e}`)}};return(t,e)=>{const r=b("el-input"),i=b("el-col"),v=b("el-option"),F=b("el-select"),I=b("el-row"),C=b("el-tag"),me=b("el-tooltip"),J=b("el-pagination"),q=he("loading");return p(),m("div",Te,[e[29]||(e[29]=u("h1",null,"PubMed & 多来源检索",-1)),u("div",Pe,[e[18]||(e[18]=u("span",{class:"input-span"},"关键词：",-1)),x(u("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>U.value=a),type:"text",placeholder:"关键词，如 cancer AND immunotherapy"},null,512),[[X,U.value]]),e[19]||(e[19]=u("span",{class:"input-span"},"检索数量：",-1)),x(u("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>M.value=a),type:"number",min:"1",max:"210",class:"input-number"},null,512),[[X,M.value,void 0,{number:!0}]]),u("button",{disabled:S.value,onClick:ne},[S.value?(p(),m("span",Ee,"搜索中...")):(p(),m("span",Ne,"搜索"))],8,Ce),u("button",{onClick:e[2]||(e[2]=a=>k.value=!0)},"查看文献列表"),u("button",{onClick:e[3]||(e[3]=a=>E.value=!0)},"查看临床试验")]),u("div",Ie,[(p(!0),m(K,null,H(ae.value,(a,R)=>(p(),m("div",{key:`line-${R}`,class:"msg"},[(p(!0),m(K,null,H(a,(_,ve)=>(p(),m("span",{key:`line-${R}-msg-${ve}`,class:"msg-item"},[_.type==="text"?(p(),m("span",{key:0,class:"msg-text",innerHTML:_.content},null,8,ke)):_.type==="link"?(p(),m("a",{key:1,href:_.href,"data-ids":_.ids,"data-event-type":_.eventType,class:"msg-link",onClick:we(fe,["prevent"])},O(_.content),9,Se)):_.type==="image"?(p(),m("img",{key:2,src:_.url,class:"msg-img",alt:""},null,8,Le)):(p(),m("span",Ve,O(JSON.stringify(_)),1))]))),128))]))),128))]),n(o(Z),{modelValue:E.value,"onUpdate:modelValue":e[10]||(e[10]=a=>E.value=a),title:"临床试验列表",width:"90%","max-height":"90vh"},{footer:l(()=>[n(o(w),{onClick:e[9]||(e[9]=a=>E.value=!1)},{default:l(()=>[...e[23]||(e[23]=[h("关闭",-1)])]),_:1})]),default:l(()=>[u("div",Re,[n(I,{gutter:10},{default:l(()=>[n(i,{span:8},{default:l(()=>[n(r,{modelValue:s.nctId,"onUpdate:modelValue":e[4]||(e[4]=a=>s.nctId=a),placeholder:"搜索NCT编号,多个逗号分隔",clearable:"",onClear:T,onKeyup:D(T,["enter"])},null,8,["modelValue"])]),_:1}),n(i,{span:6},{default:l(()=>[n(r,{modelValue:s.condition,"onUpdate:modelValue":e[5]||(e[5]=a=>s.condition=a),placeholder:"搜索疾病/条件",clearable:"",onClear:T,onKeyup:D(T,["enter"])},null,8,["modelValue"])]),_:1}),n(i,{span:6},{default:l(()=>[n(F,{modelValue:s.status,"onUpdate:modelValue":e[6]||(e[6]=a=>s.status=a),placeholder:"选择状态",clearable:"",onChange:T},{default:l(()=>[(p(),m(K,null,H(G,a=>n(v,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(i,{span:2},{default:l(()=>[n(o(w),{type:"primary",onClick:T},{default:l(()=>[...e[20]||(e[20]=[h("搜索",-1)])]),_:1})]),_:1}),n(i,{span:2},{default:l(()=>[n(o(w),{style:{"margin-left":"10px"},onClick:ce},{default:l(()=>[...e[21]||(e[21]=[h("重置",-1)])]),_:1})]),_:1})]),_:1})]),x((p(),ee(o(te),{data:W.value,style:{width:"100%"},border:"","element-loading-text":"加载中...",height:"calc(100% - 60px)"},{default:l(()=>[n(o(c),{prop:"nct_id",label:"NCT编号",align:"center"}),n(o(c),{prop:"title",label:"标题","min-width":"290"},{default:l(a=>[u("div",Ae,[u("span",null,O(a.row.title),1),a.row.official_title?(p(),m("div",Oe,O(a.row.official_title),1)):be("",!0)])]),_:1}),n(o(c),{prop:"status",label:"状态",align:"center"},{default:l(a=>[n(me,{content:re(a.row.status),placement:"top"},{default:l(()=>[n(C,{type:oe(a.row.status),effect:a.row.status==="COMPLETED"?"dark":"light",style:{cursor:"pointer"}},{default:l(()=>[h(O(le(a.row.status)),1)]),_:2},1032,["type","effect"])]),_:2},1032,["content"])]),_:1}),n(o(c),{prop:"phase",label:"临床阶段",align:"center"}),n(o(c),{prop:"study_type",label:"研究类型",align:"center"}),n(o(c),{prop:"conditions",label:"疾病/条件"}),n(o(c),{prop:"start_date",label:"开始日期",align:"center"}),n(o(c),{prop:"completion_date",label:"完成日期",align:"center"}),n(o(c),{label:"操作",align:"center"},{default:l(a=>[n(o(w),{type:"text",onClick:R=>Y(a.row.source_url),disabled:!a.row.source_url},{default:l(()=>[...e[22]||(e[22]=[h(" 原始链接 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[q,B.value]]),u("div",De,[n(J,{"current-page":g.currentPage,"onUpdate:currentPage":e[7]||(e[7]=a=>g.currentPage=a),"page-size":g.pageSize,"onUpdate:pageSize":e[8]||(e[8]=a=>g.pageSize=a),"page-sizes":[10,20,50,100],total:g.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ie,onCurrentChange:se},null,8,["current-page","page-size","total"])])]),_:1},8,["modelValue"]),n(o(Z),{modelValue:k.value,"onUpdate:modelValue":e[17]||(e[17]=a=>k.value=a),title:"已存储的文献列表",width:"80%"},{footer:l(()=>[n(o(w),{onClick:e[16]||(e[16]=a=>k.value=!1)},{default:l(()=>[...e[28]||(e[28]=[h("关闭",-1)])]),_:1})]),default:l(()=>[u("div",Ue,[n(I,{gutter:10},{default:l(()=>[n(i,{span:6},{default:l(()=>[n(r,{modelValue:d.pmid,"onUpdate:modelValue":e[11]||(e[11]=a=>d.pmid=a),placeholder:"按PMID搜索",clearable:"",onClear:P,onKeyup:D(P,["enter"])},null,8,["modelValue"])]),_:1}),n(i,{span:9},{default:l(()=>[n(r,{modelValue:d.title,"onUpdate:modelValue":e[12]||(e[12]=a=>d.title=a),placeholder:"按标题搜索",clearable:"",onClear:P,onKeyup:D(P,["enter"])},null,8,["modelValue"])]),_:1}),n(i,{span:5},{default:l(()=>[n(r,{modelValue:d.author,"onUpdate:modelValue":e[13]||(e[13]=a=>d.author=a),placeholder:"按作者搜索",clearable:"",onClear:P,onKeyup:D(P,["enter"])},null,8,["modelValue"])]),_:1}),n(i,{span:2},{default:l(()=>[n(o(w),{type:"primary",onClick:P},{default:l(()=>[...e[24]||(e[24]=[h("搜索",-1)])]),_:1})]),_:1}),n(i,{span:2},{default:l(()=>[n(o(w),{style:{"margin-left":"10px"},onClick:ge},{default:l(()=>[...e[25]||(e[25]=[h(" 重置 ",-1)])]),_:1})]),_:1})]),_:1})]),x((p(),ee(o(te),{data:j.value,style:{width:"100%"},border:""},{default:l(()=>[n(o(c),{prop:"pmid",label:"PMID",width:"120"}),n(o(c),{prop:"pmcid",label:"PMCID",width:"150"}),n(o(c),{prop:"title",label:"标题"}),n(o(c),{prop:"pub_date",label:"出版时间",width:"120"}),n(o(c),{prop:"source_type",label:"来源",width:"120"}),n(o(c),{label:"操作",width:"240"},{default:l(a=>[n(o(w),{type:"success",onClick:R=>pe(a.row.pdf_url)},{default:l(()=>[...e[26]||(e[26]=[h(" 下载 PDF ",-1)])]),_:1},8,["onClick"]),n(o(w),{type:"primary",onClick:R=>Y(a.row.source_url)},{default:l(()=>[...e[27]||(e[27]=[h(" 原文链接 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[q,$.value]]),u("div",ze,[n(J,{"current-page":f.currentPage,"onUpdate:currentPage":e[14]||(e[14]=a=>f.currentPage=a),"page-size":f.pageSize,"onUpdate:pageSize":e[15]||(e[15]=a=>f.pageSize=a),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ue,onCurrentChange:de},null,8,["current-page","page-size","total"])])]),_:1},8,["modelValue"])])}}};export{Be as default};
